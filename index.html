<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hex Habit Tracker</title>
<style>
@import url('https://fonts.cdnfonts.com/css/press-start-2p');

:root {
  --hex-size: 86px;
  --hex-tint: #3b2b5f;
  --font-size: 10px;
}

body {
  margin:0;
  background:#050505;
  font-family:'Press Start 2P', cursive;
  font-size: var(--font-size);
  color:#ddd;
  overflow-x:hidden;
}

canvas {
  position:fixed; inset:0; z-index:0;
}

#app {
  position:relative;
  z-index:2;
  padding:20px 20px 220px;
  max-width:1400px;
  margin:auto;
}

#stats {
  text-align:center;
  margin-bottom:16px;
  font-size:16px;
  z-index:2;
}

#grid {
  position:relative;
  margin:auto;
  transition: transform 0.15s ease-out;
}

.hex {
  position:absolute;
  width:var(--hex-size);
  height:calc(var(--hex-size)*0.866);
  clip-path:polygon(26% 3%,74% 3%,97% 50%,74% 97%,26% 97%,3% 50%);
  border-radius:30%;
  display:flex; align-items:center; justify-content:center;
  font-size:var(--font-size); color:#e0e0e0; cursor:pointer;
  box-shadow:0 0 0 1.4px rgba(255,255,255,0.75),0 0 12px rgba(255,255,255,0.55),0 0 26px rgba(255,255,255,0.25),inset 0 0 10px rgba(255,255,255,0.18);
  transition: transform 0.15s cubic-bezier(.2,1.4,.4,1), box-shadow 0.15s cubic-bezier(.2,1.4,.4,1), background 0.15s;
}

.hex.hoverable:hover {
  transform: scale(1.15);
  z-index:5;
}

/* COLORS */
.green { background:#1f7f50; box-shadow:0 0 0 1.6px rgba(220,255,235,1),0 0 24px rgba(90,255,200,0.85),0 0 60px rgba(60,200,150,0.55);}
.red { background:#7f1f1f; box-shadow:0 0 0 1.6px rgba(255,220,220,1),0 0 24px rgba(255,90,90,0.85),0 0 60px rgba(200,60,60,0.55);}
.yellow { background:#7f7320; box-shadow:0 0 0 1.6px rgba(255,245,200,1),0 0 24px rgba(255,230,130,0.9),0 0 60px rgba(200,180,70,0.55);}
.hex:not(.green):not(.red):not(.yellow) { background: var(--hex-tint); }

.today { box-shadow:0 0 0 2.2px white,0 0 34px rgba(255,255,255,1),0 0 80px rgba(255,255,255,0.9),0 0 140px rgba(255,255,255,0.5);}
.locked { opacity:0.55; }

#controls {
  position:fixed; bottom:0; inset-inline:0; background:#0d0d0d; padding:14px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;
  box-shadow:0 -10px 30px rgba(0,0,0,0.9); z-index:3;
}

button,input,select { background:#222; border:none; color:#ddd; padding:10px 14px; border-radius:6px; font-size:14px; font-family: 'Press Start 2P', cursive; }
button:hover, select:hover, input:hover { background:#333; }
input[type=number]{ width:60px; border-radius:6px; }

/* Settings panel */
#settingsPanel {
  position:fixed; top:0; right:-280px; width:260px; height:100%; background:#111; padding:20px;
  box-shadow:-4px 0 20px rgba(0,0,0,0.8); z-index:9999;
  display:flex; flex-direction:column; gap:8px; overflow-y:auto;
  transition: right 0.3s ease-in-out;
}
#settingsPanel.open { right:0; }
#settingsToggle { position:fixed; top:12px; right:12px; z-index:10000; background:#222; padding:10px; border-radius:6px; cursor:pointer; }

/* Slider style */
input[type=range] { -webkit-appearance:none; width:150px; height:6px; background:#444; border-radius:3px; outline:none; }
input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; height:18px; width:18px; border-radius:50%; background:#fff; cursor:pointer; box-shadow:0 0 2px #fff; }
input[type=range]::-moz-range-thumb { height:18px; width:18px; border-radius:50%; background:#fff; cursor:pointer; }

/* Saving indicator */
#syncStatus { position:fixed; bottom:12px; right:12px; font-size:12px; color:#fff; font-family:sans-serif; z-index:9999; }
</style>
</head>
<body>
<canvas id="particles"></canvas>

<div id="app">
  <div id="stats">
    Max streak: <span id="maxStreak">0</span> | Current streak: <span id="curStreak">0</span>
  </div>
  <div id="grid"></div>
</div>

<div id="controls">
  <button onclick="setDay('green')">Green</button>
  <button onclick="setDay('yellow')">Yellow</button>
  <button onclick="setDay('red')">Red</button>
  <button id="grayBtn" onclick="setDay(null)">Gray</button>
  <button id="overrideBtn">Override: OFF</button>
  <label>Days <input id="daysSlider" type="range" min="14" max="500"></label>
  <input id="daysInput" type="number" min="1" max="500">
</div>

<div id="syncStatus">Not connected</div>

<div id="settingsToggle">⚙ Settings</div>
<div id="settingsPanel">
  <label>Animations <input type="checkbox" id="animSwitch"></label>
  <label>Hex Tint: <input type="color" id="hexTint" value="#3b2b5f"></label>
  <label>Font:
    <select id="fontSelect">
      <option value="'Press Start 2P', cursive">8-bit</option>
      <option value="Arial, sans-serif">Arial</option>
      <option value="Courier New, monospace">Courier New</option>
    </select>
  </label>
  <label>Font Size: <input type="number" id="fontSizeInput" min="8" max="20" value="10"></label>
  <label>GitHub Token:</label>
  <input id="ghToken" type="password" placeholder="Personal Access Token">
  <button onclick="saveToken()">Connect</button>
</div>

<script>
const settingsPanel=document.getElementById("settingsPanel");
document.getElementById("settingsToggle").onclick=()=>settingsPanel.classList.toggle("open");

let storeKey="hexData", autoKey="hexAutoDays";
let data=JSON.parse(localStorage.getItem(storeKey)||"{}");
let override=false, selected=null;

let animEnabled=localStorage.getItem("animEnabled")!=="false"; 
document.getElementById("animSwitch").checked=animEnabled;
let hexTint=localStorage.getItem("hexTint")||"#3b2b5f";
document.getElementById("hexTint").value=hexTint;
let fontSize=localStorage.getItem("fontSize")||10;
document.getElementById("fontSizeInput").value=fontSize;
document.body.style.setProperty("--hex-tint",hexTint);
document.body.style.setProperty("--font-size",fontSize+"px");
let font=localStorage.getItem("font")||"'Press Start 2P', cursive";
document.body.style.fontFamily=font;
document.getElementById("fontSelect").value=font;

const today=()=>new Date().toISOString().split("T")[0];
const datePlus=n=>{const d=new Date();d.setDate(d.getDate()+n);return d;}
const key=d=>d.toISOString().split("T")[0];

function getAutoDays(){
  const t=today();
  let s=JSON.parse(localStorage.getItem(autoKey)||"{}");
  if(!s.date) s={date:t,days:60};
  const diff=(new Date(t)-new Date(s.date))/86400000;
  if(diff>0){s.days+=diff;s.date=t;}
  localStorage.setItem(autoKey,JSON.stringify(s));
  return s.days;
}
let days=getAutoDays();
daysSlider.value=daysInput.value=days;
daysSlider.oninput=()=>{days=+daysSlider.value;daysInput.value=days;render();}
daysInput.onchange=()=>{days=Math.min(500,Math.max(1,+daysInput.value||1));daysSlider.value=days;render();}

overrideBtn.onclick=()=>{ override=!override; overrideBtn.textContent=override?"Override: ON":"Override: OFF"; grayBtn.style.display=override?"inline-block":"none"; }

document.getElementById("animSwitch").onchange=function(){
  animEnabled=this.checked; localStorage.setItem("animEnabled",animEnabled); render();
};
document.getElementById("hexTint").oninput=function(){
  hexTint=this.value; localStorage.setItem("hexTint",hexTint); document.body.style.setProperty("--hex-tint",hexTint); render();
};
document.getElementById("fontSelect").onchange=function(){
  font=this.value; localStorage.setItem("font",font); document.body.style.fontFamily=font;
};
document.getElementById("fontSizeInput").oninput=function(){
  fontSize=this.value; localStorage.setItem("fontSize",fontSize); document.body.style.setProperty("--font-size",fontSize+"px"); render();
};

let GH={owner:"23CadenS", repo:"Habit-Tracker", path:"data.json", token:localStorage.getItem("ghToken"), sha:null};
let unsaved=false;
const syncStatus=document.getElementById("syncStatus");

async function saveToken(){
  GH.token=document.getElementById("ghToken").value;
  localStorage.setItem("ghToken",GH.token);
  syncStatus.textContent="Checking token...";
  try{
    const res=await fetch("https://api.github.com/user",{headers:{Authorization:"token "+GH.token}});
    if(!res.ok) throw new Error("Token invalid");
    syncStatus.textContent="Connected ✓";
    await loadDataFromGitHub();
    await applySettingsFromGitHub();
  }catch(e){ syncStatus.textContent="Token invalid ❌"; }
}

window.addEventListener("beforeunload", e=>{ if(unsaved){ e.preventDefault(); e.returnValue=""; } });

function setDay(color){
  if(!selected) return;
  const k=key(selected);
  if(!override && k!==today()) return;
  if(color===null) delete data[k]; else data[k]=color;
  unsaved=true; render(); autoSave();
}

function calcStreaks(){
  let max=0,cur=0,prev=null;
  Object.keys(data).sort().forEach(k=>{
    if(data[k]==="green"){ cur=prev&&(new Date(k)-new Date(prev)===86400000)?cur+1:1; max=Math.max(max,cur); prev=k; }
  });
  let run=0; for(let i=0;;i--){ const k=key(datePlus(i)); if(data[k]==="green") run++; else break; }
  return {max,cur:run};
}

function render(){
  grid.innerHTML="";
  const size=Math.max(36,96-days*0.12); document.documentElement.style.setProperty("--hex-size",size+"px");
  const w=size,h=size*0.866,gap=w*0.78;
  const rows=Math.max(6,Math.floor((innerHeight-260)/h));
  for(let i=0;i<days;i++){
    const col=Math.floor(i/rows),row=i%rows;
    const d=datePlus(i),k=key(d);
    const hex=document.createElement("div"); hex.className="hex";
    if(animEnabled) hex.classList.add("hoverable");
    if(data[k]) hex.classList.add(data[k]); else hex.style.background=hexTint;
    if(k===today()){ hex.classList.add("today"); selected=d; }
    if(!override && k!==today()) hex.classList.add("locked");
    hex.textContent=d.toLocaleDateString(undefined,{month:"short",day:"numeric"});
    hex.style.left=(col*gap)+"px"; hex.style.top=(row*h+(col%2?h/2:0))+"px";
    hex.onclick=()=>selected=d; grid.appendChild(hex);
  }
  grid.style.width=(Math.ceil(days/rows)*gap+w)+"px"; grid.style.height=(rows*h+h)+"px";
  const s=calcStreaks(); maxStreak.textContent=s.max; curStreak.textContent=s.cur;
}
render(); onresize=render;

// Load from GitHub
async function loadDataFromGitHub() {
    if (!GH.token) return;
    syncStatus.textContent = "Loading data...";
    try {
        const res = await fetch(`https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${GH.path}`,{
            headers:{ Authorization: "token " + GH.token }
        });
        const body = await res.json();
        if(body.content){
            const parsed = JSON.parse(atob(body.content));
            if(parsed.data) data = parsed.data;
            unsaved=false;
            render();
            GH.sha = body.sha;
            syncStatus.textContent = "Loaded ✓";
            localStorage.setItem(storeKey, JSON.stringify(data));
        }
    } catch(e){ console.error(e); syncStatus.textContent="Error loading ❌"; }
}

// Apply saved settings from GitHub
async function applySettingsFromGitHub() {
    if(!GH.token) return;
    try {
        const res = await fetch(`https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${GH.path}`,{
            headers:{ Authorization: "token " + GH.token }
        });
        const body = await res.json();
        if(body.content){
            const saved = JSON.parse(atob(body.content));
            if(saved.settings){
                animEnabled = saved.settings.animEnabled;
                hexTint = saved.settings.hexTint;
                font = saved.settings.font;
                fontSize = saved.settings.fontSize;

                document.getElementById("animSwitch").checked = animEnabled;
                document.getElementById("hexTint").value = hexTint;
                document.getElementById("fontSelect").value = font;
                document.getElementById("fontSizeInput").value = fontSize;

                document.body.style.setProperty("--hex-tint",hexTint);
                document.body.style.fontFamily = font;
                document.body.style.setProperty("--font-size",fontSize+"px");
                render();
            }
        }
    } catch(e){ console.error(e); }
}

// Auto-save to GitHub
async function autoSave(){
    if(!GH.token) return;
    syncStatus.textContent="Saving...";
    const payload = btoa(JSON.stringify({data,settings:{
        animEnabled, hexTint, font, fontSize
    }}, null, 2));
    try{
        let res = await fetch(`https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${GH.path}`,{
            headers:{Authorization:"token "+GH.token}
        });
        let body = await res.json();
        let sha = body.sha || null;
        res = await fetch(`https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${GH.path}`,{
            method:"PUT",
            headers:{ Authorization:"token "+GH.token, "Content-Type":"application/json" },
            body: JSON.stringify({message:"Update habit data", content: payload, sha: sha})
        });
        const result = await res.json();
        if(result.content){ GH.sha = result.content.sha; unsaved=false; syncStatus.textContent="Saved ✓"; }
        else syncStatus.textContent="Error saving ❌";
    } catch(e){ syncStatus.textContent="Error saving ❌"; console.error(e);}
}

// PARTICLES
const ctx=particles.getContext("2d");
function resize(){particles.width=innerWidth;particles.height=innerHeight;}
resize(); onresize=resize;
const parts=[...Array(100)].map(()=>({x:Math.random()*innerWidth,y:Math.random()*innerHeight,r:Math.random()*2+.5,v:Math.random()*.25+.1}));
(function anim(){
  if(animEnabled){
    ctx.clearRect(0,0,particles.width,particles.height);
    ctx.fillStyle="rgba(255,255,255,.18)";
    parts.forEach(p=>{p.y-=p.v;if(p.y<0)p.y=particles.height;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();});
  }
  requestAnimationFrame(anim);
})();

// Mouse reaction
addEventListener("mousemove",e=>{
  if(animEnabled) grid.style.transform=`translate(${(e.clientX/innerWidth-.5)*16}px,${(e.clientY/innerHeight-.5)*16}px)`;
});
</script>
</body>
</html>
